// Prisma Schema for HRPlatform
// Database: PostgreSQL (Supabase)
// Multi-tenancy: Row-Level Security (RLS)
// Generated: Phase 0.2

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// CORE: MULTI-TENANCY & AUTHENTICATION
// ============================================================================

/// Company/Organization - Root of multi-tenancy
model Company {
  id          String   @id @default(uuid()) @db.Uuid
  companyCode String   @unique @map("company_code") @db.VarChar(50)
  companyName String   @map("company_name") @db.VarChar(255)
  
  // Subscription
  subscriptionTier   String  @default("FREE") @map("subscription_tier") @db.VarChar(50)
  subscriptionStatus String  @default("TRIAL") @map("subscription_status") @db.VarChar(50)
  trialEndsAt        DateTime? @map("trial_ends_at") @db.Timestamptz
  
  // Contact
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  website     String?  @db.VarChar(255)
  
  // Address
  addressLine1 String? @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(100)
  country      String? @default("India") @db.VarChar(100)
  postalCode   String? @map("postal_code") @db.VarChar(20)
  
  // Settings (JSON)
  settings Json @default("{}") @db.JsonB
  
  // Deployment
  deploymentType String @default("CLOUD") @map("deployment_type") @db.VarChar(50)
  databaseSchema String? @map("database_schema") @db.VarChar(100)
  
  // Features enabled
  featuresEnabled String[] @default([]) @map("features_enabled")

  // Onboarding
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep      Int     @default(0) @map("onboarding_step")

  // SSO Configuration (JSON)
  ssoConfig Json? @map("sso_config") @db.JsonB
  // Structure: { provider: 'google'|'saml', enabled: boolean, googleClientId?, googleClientSecret?, samlEntryPoint?, samlIssuer?, samlCert?, allowedDomains?: string[] }

  // Payroll Configuration
  payrollCountry    String?  @default("IN") @map("payroll_country") @db.VarChar(5) // IN or US
  payFrequency      String?  @default("MONTHLY") @map("pay_frequency") @db.VarChar(20) // MONTHLY, SEMI_MONTHLY, BI_WEEKLY, WEEKLY
  pfEnabled         Boolean  @default(false) @map("pf_enabled") // PF toggle (India)
  esiEnabled        Boolean  @default(false) @map("esi_enabled") // ESI toggle (India)
  emailPayslipEnabled Boolean @default(false) @map("email_payslip_enabled") // Auto-email payslip on PAID

  // India Company Registrations - ENCRYPTED
  companyPanEncrypted String? @map("company_pan_encrypted") @db.Text // India Company PAN (mandatory)
  gstinEncrypted      String? @map("gstin_encrypted") @db.Text // India GSTIN
  tanEncrypted        String? @map("tan_encrypted") @db.Text // India TAN (for TDS filing)
  pfRegNo             String? @map("pf_reg_no") @db.VarChar(100) // India PF Registration No
  esiRegNo            String? @map("esi_reg_no") @db.VarChar(100) // India ESI Registration No

  // US Company Registration - ENCRYPTED
  einEncrypted        String? @map("ein_encrypted") @db.Text // US EIN

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  users        User[]
  employees    Employee[]
  departments  Department[]
  designations Designation[]
  attendance   Attendance[]
  leaves       Leave[]
  payroll      Payroll[]
  auditLogs    AuditLog[]
  notifications     Notification[]
  invitations       Invitation[]
  documents         Document[]
  workflowTemplates WorkflowTemplate[]
  workflowInstances WorkflowInstance[]
  apiKeys           ApiKey[]
  webhookEndpoints  WebhookEndpoint[]
  customFieldDefinitions CustomFieldDefinition[]
  reviewCycles      ReviewCycle[]
  jobPostings       JobPosting[]
  applicants        Applicant[]
  trainingCourses   TrainingCourse[]
  assets            Asset[]
  expenseClaims     ExpenseClaim[]
  shiftDefinitions  ShiftDefinition[]
  policies          Policy[]
  companyAddons     CompanyAddon[]
  companyBilling    CompanyBilling?
  salaryStructures  SalaryStructure[]
  payrollBatches    PayrollBatch[]
  payrollYTDs       PayrollYTD[]
  taxConfigurations TaxConfiguration[]
  approvalDelegations    ApprovalDelegation[]
  offboardingChecklists  OffboardingChecklist[]
  offboardingProcesses   OffboardingProcess[]
  leavePolicies          LeavePolicy[]
  leaveBalances          LeaveBalance[]
  announcements          Announcement[]
  kudos                  Kudos[]
  surveys                Survey[]
  timesheets             Timesheet[]
  projects               Project[]
  contractors            Contractor[]
  contractorInvoices     ContractorInvoice[]
  geofenceZones          GeofenceZone[]

  @@index([createdAt])
  @@map("companies")
}

/// Users - Authentication & Authorization
model User {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  
  // Auth (can use Supabase Auth or custom)
  email         String   @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.Text
  supabaseAuthId String? @unique @map("supabase_auth_id") @db.Uuid
  googleId       String? @unique @map("google_id") @db.VarChar(255)
  
  // Profile
  firstName String  @map("first_name") @db.VarChar(100)
  lastName  String  @map("last_name") @db.VarChar(100)
  phone     String? @db.VarChar(20)
  avatar    String? @db.Text
  
  // Role & Permissions
  // Note: SUPER_ADMIN role is for the separate Super Admin app (different repo)
  // SUPER_ADMIN users bypass RLS and manage all companies
  role        String   @db.VarChar(50) // SUPER_ADMIN (from Super Admin app), COMPANY_ADMIN, HR_ADMIN, MANAGER, EMPLOYEE
  permissions String[] @default([])
  
  // Link to employee record (if user is also an employee)
  employeeId String? @unique @map("employee_id") @db.Uuid
  
  // Status
  isActive       Boolean   @default(true) @map("is_active")
  emailVerified  Boolean   @default(false) @map("email_verified")
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz
  passwordChangedAt DateTime? @map("password_changed_at") @db.Timestamptz
  
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  
  // Relations
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id])
  notifications      Notification[]
  invitationsSent    Invitation[] @relation("InvitationInviter")
  documentsUploaded  Document[]
  workflowsInitiated WorkflowInstance[] @relation("WorkflowInitiator")
  workflowStepsResolved WorkflowStep[] @relation("WorkflowStepResolver")
  apiKeysCreated     ApiKey[] @relation("ApiKeyCreator")
  delegationsOut     ApprovalDelegation[] @relation("DelegationDelegator")
  delegationsIn      ApprovalDelegation[] @relation("DelegationDelegate")
  announcementsAuthored Announcement[]
  kudosSent          Kudos[] @relation("KudosSender")
  surveysCreated     Survey[]
  surveyResponses    SurveyResponse[]
  dashboardConfig    DashboardConfig?

  @@unique([companyId, email])
  @@index([companyId])
  @@index([email])
  @@index([supabaseAuthId])
  @@index([createdAt])
  @@index([isActive])
  @@map("users")
}

// ============================================================================
// HR: ORGANIZATIONAL STRUCTURE
// ============================================================================

/// Departments
model Department {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  
  name        String   @db.VarChar(100)
  code        String   @db.VarChar(50)
  description String?  @db.Text
  
  // Hierarchy
  parentId    String?  @map("parent_id") @db.Uuid
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  
  // Head of department
  headEmployeeId String? @map("head_employee_id") @db.Uuid
  
  // Cost center
  costCenter  String?  @map("cost_center") @db.VarChar(50)
  
  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  
  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([createdAt])
  @@map("departments")
}

/// Designations/Job Titles
model Designation {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  
  title       String   @db.VarChar(100)
  code        String   @db.VarChar(50)
  description String?  @db.Text
  level       Int      @default(1) // 1=Entry, 2=Junior, 3=Mid, 4=Senior, 5=Lead, 6=Manager, 7=Director, 8=VP, 9=C-Level
  
  // Salary band
  minSalary   Decimal? @map("min_salary") @db.Decimal(15, 2)
  maxSalary   Decimal? @map("max_salary") @db.Decimal(15, 2)
  currency    String   @default("INR") @db.VarChar(10)
  
  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  
  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([createdAt])
  @@map("designations")
}

// ============================================================================
// HR: EMPLOYEE MANAGEMENT
// ============================================================================

/// Employees - Core employee data
model Employee {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  
  // Employee identification
  employeeCode String @map("employee_code") @db.VarChar(50)
  
  // Personal information
  firstName  String   @map("first_name") @db.VarChar(100)
  middleName String?  @map("middle_name") @db.VarChar(100)
  lastName   String   @map("last_name") @db.VarChar(100)
  
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  gender      String?   @db.VarChar(20)
  
  // Contact (work)
  workEmail   String   @map("work_email") @db.VarChar(255)
  workPhone   String?  @map("work_phone") @db.VarChar(20)
  
  // Contact (personal) - ENCRYPTED in application
  personalEmailEncrypted String? @map("personal_email_encrypted") @db.Text
  personalPhoneEncrypted String? @map("personal_phone_encrypted") @db.Text
  
  // Government IDs - ENCRYPTED in application
  aadhaarEncrypted String? @map("aadhaar_encrypted") @db.Text
  panEncrypted     String? @map("pan_encrypted") @db.Text
  passportEncrypted String? @map("passport_encrypted") @db.Text
  
  // Address
  addressLine1 String? @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(100)
  country      String? @default("India") @db.VarChar(100)
  postalCode   String? @map("postal_code") @db.VarChar(20)
  
  // Employment
  dateOfJoining  DateTime  @map("date_of_joining") @db.Date
  dateOfLeaving  DateTime? @map("date_of_leaving") @db.Date
  probationEndDate DateTime? @map("probation_end_date") @db.Date
  
  departmentId   String?   @map("department_id") @db.Uuid
  designationId  String?   @map("designation_id") @db.Uuid
  
  // Reporting
  reportingManagerId String? @map("reporting_manager_id") @db.Uuid
  reportingManager   Employee?  @relation("EmployeeReporting", fields: [reportingManagerId], references: [id])
  reportees          Employee[] @relation("EmployeeReporting")
  
  // Employment type
  employmentType String @default("FULL_TIME") @map("employment_type") @db.VarChar(50) // FULL_TIME, PART_TIME, CONTRACT, INTERN

  // Tax & Payroll Details
  taxRegime          String?  @map("tax_regime") @db.VarChar(10) // NEW or OLD (India)
  filingStatus       String?  @map("filing_status") @db.VarChar(50) // US filing status (SINGLE, MFJ, MFS, HOH)
  w4Allowances       Int?     @default(0) @map("w4_allowances") // US W-4 allowances
  ssnEncrypted       String?  @map("ssn_encrypted") @db.Text // US SSN (encrypted)
  uanEncrypted       String?  @map("uan_encrypted") @db.Text // India UAN for PF (encrypted)
  salaryStructureId  String?  @map("salary_structure_id") @db.Uuid // FK to SalaryStructure
  annualCtc          Decimal? @map("annual_ctc") @db.Decimal(15, 2) // Annual CTC for salary computation

  // Offboarding
  noticePeriodDays   Int?     @map("notice_period_days")
  terminationReason  String?  @map("termination_reason") @db.Text

  // Status
  status    String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, ON_NOTICE, RESIGNED, TERMINATED, ON_LEAVE
  isActive  Boolean   @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department      Department?      @relation(fields: [departmentId], references: [id])
  designation     Designation?     @relation(fields: [designationId], references: [id])
  salaryStructure SalaryStructure? @relation(fields: [salaryStructureId], references: [id])
  user            User?

  attendance  Attendance[]
  leaves      Leave[]
  payroll     Payroll[]
  documents   Document[]
  payrollYTDs PayrollYTD[]
  offboardingProcesses OffboardingProcess[]
  kudosReceived        Kudos[]
  leaveBalances        LeaveBalance[]
  timesheets           Timesheet[]

  @@unique([companyId, employeeCode])
  @@index([companyId])
  @@index([workEmail])
  @@index([departmentId])
  @@index([designationId])
  @@index([reportingManagerId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("employees")
}

// ============================================================================
// ATTENDANCE & TIME TRACKING
// ============================================================================

/// Attendance records
model Attendance {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid
  
  // Date & time
  attendanceDate DateTime @map("attendance_date") @db.Date
  checkInTime    DateTime? @map("check_in_time") @db.Timestamptz
  checkOutTime   DateTime? @map("check_out_time") @db.Timestamptz
  
  // Work details
  totalHours  Decimal? @map("total_hours") @db.Decimal(5, 2)
  breakHours  Decimal? @default(0) @map("break_hours") @db.Decimal(5, 2)
  overtimeHours Decimal? @default(0) @map("overtime_hours") @db.Decimal(5, 2)
  
  // Status
  status      String   @default("PRESENT") @db.VarChar(50) // PRESENT, ABSENT, LEAVE, HALF_DAY, WEEKEND, HOLIDAY
  isWorkFromHome Boolean @default(false) @map("is_wfh")
  
  // Location (if GPS tracking)
  checkInLatitude  Decimal? @map("check_in_latitude") @db.Decimal(10, 8)
  checkInLongitude Decimal? @map("check_in_longitude") @db.Decimal(11, 8)
  checkOutLatitude  Decimal? @map("check_out_latitude") @db.Decimal(10, 8)
  checkOutLongitude Decimal? @map("check_out_longitude") @db.Decimal(11, 8)
  
  // IP & Verification (geofencing)
  ipAddress          String?  @map("ip_address") @db.VarChar(45)
  locationVerified   Boolean  @default(false) @map("location_verified")

  // Regularization
  isRegularized Boolean   @default(false) @map("is_regularized")
  regularizedBy String?   @map("regularized_by") @db.Uuid
  regularizedAt DateTime? @map("regularized_at") @db.Timestamptz
  regularizationReason String? @map("regularization_reason") @db.Text
  
  // Notes
  notes String? @db.Text
  
  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, employeeId, attendanceDate])
  @@index([companyId])
  @@index([employeeId])
  @@index([attendanceDate])
  @@map("attendance")
}

// ============================================================================
// LEAVE MANAGEMENT
// ============================================================================

/// Leave applications
model Leave {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid
  
  // Leave details
  leaveType  String   @map("leave_type") @db.VarChar(50) // CASUAL, SICK, EARNED, PRIVILEGE, MATERNITY, PATERNITY, etc.
  startDate  DateTime @map("start_date") @db.Date
  endDate    DateTime @map("end_date") @db.Date
  
  // Duration
  totalDays  Decimal  @map("total_days") @db.Decimal(5, 2) // Supports half-day (0.5)
  isHalfDay  Boolean  @default(false) @map("is_half_day")
  halfDayType String? @map("half_day_type") @db.VarChar(20) // FIRST_HALF, SECOND_HALF
  
  // Details
  reason     String   @db.Text
  contactDuringLeave String? @map("contact_during_leave") @db.VarChar(255)
  
  // Approval workflow
  status     String   @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED, CANCELLED
  appliedAt  DateTime @default(now()) @map("applied_at") @db.Timestamptz
  
  approvedBy String?   @map("approved_by") @db.Uuid
  approvedAt DateTime? @map("approved_at") @db.Timestamptz
  approvalNotes String? @map("approval_notes") @db.Text
  
  // Cancellation
  cancelledAt DateTime? @map("cancelled_at") @db.Timestamptz
  cancellationReason String? @map("cancellation_reason") @db.Text
  
  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([createdAt])
  @@map("leaves")
}

// ============================================================================
// PAYROLL
// ============================================================================

/// Payroll records
model Payroll {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid

  // Pay period
  payPeriodMonth Int    @map("pay_period_month") // 1-12
  payPeriodYear  Int    @map("pay_period_year")
  payDate        DateTime? @map("pay_date") @db.Date

  // Region context (snapshot at time of processing)
  country       String   @default("IN") @db.VarChar(5) // IN or US
  payFrequency  String   @default("MONTHLY") @map("pay_frequency") @db.VarChar(20) // MONTHLY, SEMI_MONTHLY, BI_WEEKLY, WEEKLY

  // Bonus flag
  isBonus       Boolean  @default(false) @map("is_bonus") // Bonus payouts: TDS/federal YES, PF/ESI/FICA NO
  bonusAmount   Decimal? @map("bonus_amount") @db.Decimal(15, 2)

  // Salary components - ENCRYPTED in application
  basicSalaryEncrypted     String @map("basic_salary_encrypted") @db.Text
  hraEncrypted             String? @map("hra_encrypted") @db.Text
  specialAllowanceEncrypted String? @map("special_allowance_encrypted") @db.Text
  otherAllowancesEncrypted String? @map("other_allowances_encrypted") @db.Text

  // Gross & Net - ENCRYPTED
  grossSalaryEncrypted String @map("gross_salary_encrypted") @db.Text
  netSalaryEncrypted   String @map("net_salary_encrypted") @db.Text

  // Earnings breakdown (JSON array of computed salary components)
  earningsBreakdown Json? @map("earnings_breakdown") @db.JsonB // [{ name, amount, type, isTaxable }]

  // India Deductions (stored as decimals for calculations)
  pfEmployee  Decimal @default(0) @map("pf_employee") @db.Decimal(15, 2)
  pfEmployer  Decimal @default(0) @map("pf_employer") @db.Decimal(15, 2)
  esiEmployee Decimal @default(0) @map("esi_employee") @db.Decimal(15, 2)
  esiEmployer Decimal @default(0) @map("esi_employer") @db.Decimal(15, 2)
  tds         Decimal @default(0) @db.Decimal(15, 2)
  pt          Decimal @default(0) @db.Decimal(15, 2) // Professional Tax
  otherDeductions Decimal @default(0) @map("other_deductions") @db.Decimal(15, 2)

  // US Deductions
  ssEmployee       Decimal @default(0) @map("ss_employee") @db.Decimal(15, 2) // Social Security employee
  ssEmployer       Decimal @default(0) @map("ss_employer") @db.Decimal(15, 2) // Social Security employer
  medicareEmployee Decimal @default(0) @map("medicare_employee") @db.Decimal(15, 2)
  medicareEmployer Decimal @default(0) @map("medicare_employer") @db.Decimal(15, 2)
  federalTax       Decimal @default(0) @map("federal_tax") @db.Decimal(15, 2) // Federal withholding
  stateTax         Decimal @default(0) @map("state_tax") @db.Decimal(15, 2) // State withholding

  // Attendance impact
  daysWorked    Int     @map("days_worked")
  daysInMonth   Int     @map("days_in_month")
  leaveDays     Int     @default(0) @map("leave_days")
  absentDays    Int     @default(0) @map("absent_days")
  overtimeHours Decimal @default(0) @map("overtime_hours") @db.Decimal(5, 2)

  // Bank details - ENCRYPTED
  bankAccountEncrypted String? @map("bank_account_encrypted") @db.Text
  ifscCodeEncrypted    String? @map("ifsc_code_encrypted") @db.Text
  bankName             String? @map("bank_name") @db.VarChar(100)
  // US bank details - ENCRYPTED
  routingNumberEncrypted String? @map("routing_number_encrypted") @db.Text

  // Status
  status    String   @default("DRAFT") @db.VarChar(50) // DRAFT, PROCESSED, PAID, HOLD
  paidAt    DateTime? @map("paid_at") @db.Timestamptz

  // Approval workflow
  approvalStatus String? @map("approval_status") @db.VarChar(30) // PENDING_APPROVAL, APPROVED, REJECTED (null = no workflow)

  // Batch processing
  batchId String? @map("batch_id") @db.Uuid

  // Salary structure snapshot
  salaryStructureId String? @map("salary_structure_id") @db.Uuid
  taxRegimeUsed     String? @map("tax_regime_used") @db.VarChar(10) // Snapshot: NEW or OLD (India)

  // Tax computation breakdown (detailed JSON for payslip display)
  computationBreakdown Json? @map("computation_breakdown") @db.JsonB

  // Payslip
  payslipPath String? @map("payslip_path") @db.Text

  // Notes
  notes String? @db.Text

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  batch    PayrollBatch? @relation(fields: [batchId], references: [id])

  @@unique([companyId, employeeId, payPeriodMonth, payPeriodYear])
  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
  @@index([payPeriodYear, payPeriodMonth])
  @@index([batchId])
  @@map("payroll")
}

/// Salary structure templates — reusable component definitions
model SalaryStructure {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  country     String   @default("IN") @db.VarChar(5) // IN or US

  // Salary components as JSON array:
  // [{ name: string, type: 'EARNING'|'DEDUCTION', calculationType: 'FIXED'|'PERCENTAGE_OF_BASIC'|'PERCENTAGE_OF_GROSS', value: number, isTaxable: boolean }]
  components  Json     @db.JsonB

  // Optional link to a designation (all employees with this designation use this structure)
  designationId String? @map("designation_id") @db.Uuid

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]

  @@index([companyId])
  @@index([designationId])
  @@map("salary_structures")
}

/// Payroll batch — tracks a bulk payroll processing run
model PayrollBatch {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid

  // Period
  month      Int      // 1-12
  year       Int

  // Processing status
  status         String   @default("PENDING") @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED, PARTIAL
  totalCount     Int      @default(0) @map("total_count")
  processedCount Int      @default(0) @map("processed_count")
  failedCount    Int      @default(0) @map("failed_count")

  // Error details (array of { employeeId, error })
  errors         Json?    @db.JsonB

  // Who initiated
  initiatedBy    String   @map("initiated_by") @db.Uuid

  // Timestamps
  completedAt DateTime? @map("completed_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  payrolls Payroll[]

  @@unique([companyId, month, year])
  @@index([companyId])
  @@index([status])
  @@map("payroll_batches")
}

/// Year-to-date payroll totals per employee (critical for cumulative tax calculations)
model PayrollYTD {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  employeeId  String   @map("employee_id") @db.Uuid
  fiscalYear  Int      @map("fiscal_year") // e.g., 2025 for FY 2025-26 (India) or CY 2025 (US)

  // Cumulative totals - ENCRYPTED
  grossEarningsEncrypted  String  @map("gross_earnings_encrypted") @db.Text
  totalDeductionsEncrypted String @map("total_deductions_encrypted") @db.Text
  taxPaidEncrypted        String  @map("tax_paid_encrypted") @db.Text

  // India YTD
  pfEmployeeYtd    Decimal @default(0) @map("pf_employee_ytd") @db.Decimal(15, 2)
  pfEmployerYtd    Decimal @default(0) @map("pf_employer_ytd") @db.Decimal(15, 2)
  esiEmployeeYtd   Decimal @default(0) @map("esi_employee_ytd") @db.Decimal(15, 2)
  esiEmployerYtd   Decimal @default(0) @map("esi_employer_ytd") @db.Decimal(15, 2)
  tdsYtd           Decimal @default(0) @map("tds_ytd") @db.Decimal(15, 2)
  ptYtd            Decimal @default(0) @map("pt_ytd") @db.Decimal(15, 2)

  // US YTD
  ssEmployeeYtd    Decimal @default(0) @map("ss_employee_ytd") @db.Decimal(15, 2)
  ssEmployerYtd    Decimal @default(0) @map("ss_employer_ytd") @db.Decimal(15, 2)
  medicareYtd      Decimal @default(0) @map("medicare_ytd") @db.Decimal(15, 2)
  federalTaxYtd    Decimal @default(0) @map("federal_tax_ytd") @db.Decimal(15, 2)
  stateTaxYtd      Decimal @default(0) @map("state_tax_ytd") @db.Decimal(15, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([companyId, employeeId, fiscalYear])
  @@index([companyId])
  @@index([employeeId])
  @@index([fiscalYear])
  @@map("payroll_ytd")
}

/// Tax configuration — DB-driven tax rates, seeded at day-0, admin-updatable per fiscal year
model TaxConfiguration {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String?  @map("company_id") @db.Uuid // null = global default, set = company override

  // Configuration
  country     String   @db.VarChar(5) // IN or US
  configKey   String   @map("config_key") @db.VarChar(100) // e.g., 'IN_NEW_REGIME_BRACKETS', 'US_FICA_CONFIG'
  configValue Json     @map("config_value") @db.JsonB // The actual rate data (slabs, percentages, etc.)
  fiscalYear  Int      @map("fiscal_year") // 2025 for FY 2025-26 (India) or CY 2025 (US)

  // Validity period
  effectiveFrom DateTime  @map("effective_from") @db.Timestamptz
  effectiveTo   DateTime  @map("effective_to") @db.Timestamptz

  // Status
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([country, configKey, fiscalYear])
  @@index([country])
  @@index([fiscalYear])
  @@index([companyId])
  @@map("tax_configurations")
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

/// Audit logs for compliance (7-year retention)
model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  
  // Who
  userId    String?  @map("user_id") @db.Uuid
  userEmail String?  @map("user_email") @db.VarChar(255)
  
  // What
  action       String   @db.VarChar(50) // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT, etc.
  resourceType String   @map("resource_type") @db.VarChar(100) // EMPLOYEE, PAYROLL, LEAVE, etc.
  resourceId   String?  @map("resource_id") @db.Uuid
  
  // Changes (for UPDATE/DELETE)
  oldValues Json?    @map("old_values") @db.JsonB
  newValues Json?    @map("new_values") @db.JsonB
  
  // Context
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  requestId String?  @map("request_id") @db.Uuid
  
  // Result
  success       Boolean @default(true)
  failureReason String? @map("failure_reason") @db.Text
  
  // Metadata
  metadata Json?    @db.JsonB
  
  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

/// In-app notifications for users
model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid

  // Notification content
  type      String   @db.VarChar(50) // LEAVE_APPROVED, LEAVE_REJECTED, INVITATION_RECEIVED, DOCUMENT_UPLOADED, ATTENDANCE_MARKED, PAYROLL_PROCESSED, SYSTEM, etc.
  title     String   @db.VarChar(255)
  message   String   @db.Text

  // Link to related resource
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.Uuid
  actionUrl    String? @map("action_url") @db.Text

  // Status
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at") @db.Timestamptz

  // Email tracking
  emailSent   Boolean  @default(false) @map("email_sent")
  emailSentAt DateTime? @map("email_sent_at") @db.Timestamptz

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// INVITATIONS
// ============================================================================

/// User invitations for onboarding new team members
model Invitation {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Invitation details
  email     String   @db.VarChar(255)
  role      String   @db.VarChar(50) // Target role for the invited user

  // Token for invitation link
  token     String   @unique @db.VarChar(255)

  // Inviter
  invitedBy String   @map("invited_by") @db.Uuid

  // Status
  status    String   @default("PENDING") @db.VarChar(50) // PENDING, ACCEPTED, EXPIRED, REVOKED
  expiresAt DateTime @map("expires_at") @db.Timestamptz

  // Acceptance
  acceptedAt DateTime? @map("accepted_at") @db.Timestamptz
  acceptedUserId String? @map("accepted_user_id") @db.Uuid

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter  User    @relation("InvitationInviter", fields: [invitedBy], references: [id])

  @@index([companyId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

/// Document management for employee files
model Document {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid

  // Document details
  name       String   @db.VarChar(255)
  description String? @db.Text

  // File info
  fileName   String   @map("file_name") @db.VarChar(255)
  filePath   String   @map("file_path") @db.Text
  mimeType   String   @map("mime_type") @db.VarChar(100)
  fileSize   Int      @map("file_size") // bytes

  // Classification
  category   String   @db.VarChar(100) // OFFER_LETTER, CONTRACT, ID_PROOF, CERTIFICATE, POLICY, OTHER

  // Ownership
  employeeId String?  @map("employee_id") @db.Uuid
  uploadedBy String   @map("uploaded_by") @db.Uuid

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id])
  uploader User      @relation(fields: [uploadedBy], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([category])
  @@map("documents")
}

// ============================================================================
// WORKFLOWS
// ============================================================================

/// Workflow template - defines an approval chain
model WorkflowTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Template info
  name        String   @db.VarChar(255)
  description String?  @db.Text
  entityType  String   @map("entity_type") @db.VarChar(100) // LEAVE, EXPENSE, DOCUMENT, etc.

  // Steps definition (JSON array of step configs)
  // Each step: { order, approverType: 'ROLE'|'USER'|'MANAGER', approverValue: string, required: boolean }
  steps Json @db.JsonB

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  instances WorkflowInstance[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([entityType])
  @@map("workflow_templates")
}

/// Workflow instance - a running workflow for a specific entity
model WorkflowInstance {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  templateId String   @map("template_id") @db.Uuid

  // What entity this workflow is for
  entityType String   @map("entity_type") @db.VarChar(100) // LEAVE, EXPENSE, etc.
  entityId   String   @map("entity_id") @db.Uuid

  // Who initiated
  initiatedBy String  @map("initiated_by") @db.Uuid

  // Current state
  currentStepOrder Int    @default(1) @map("current_step_order")
  status           String @default("PENDING") @db.VarChar(50) // PENDING, IN_PROGRESS, APPROVED, REJECTED, CANCELLED

  // Timestamps
  completedAt DateTime? @map("completed_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  template WorkflowTemplate @relation(fields: [templateId], references: [id])
  initiator User            @relation("WorkflowInitiator", fields: [initiatedBy], references: [id])
  steps    WorkflowStep[]

  @@index([companyId])
  @@index([templateId])
  @@index([entityType, entityId])
  @@index([status])
  @@map("workflow_instances")
}

/// Workflow step - individual approval step in a running workflow
model WorkflowStep {
  id         String   @id @default(uuid()) @db.Uuid
  instanceId String   @map("instance_id") @db.Uuid

  // Step info
  stepOrder     Int     @map("step_order")
  approverType  String  @map("approver_type") @db.VarChar(50) // ROLE, USER, MANAGER
  approverValue String  @map("approver_value") @db.VarChar(255) // role name, user ID, or 'REPORTING_MANAGER'

  // Resolution
  status     String  @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED, SKIPPED
  resolvedBy String? @map("resolved_by") @db.Uuid
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz
  comments   String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  instance WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  resolver User?            @relation("WorkflowStepResolver", fields: [resolvedBy], references: [id])

  @@index([instanceId])
  @@index([status])
  @@map("workflow_steps")
}

// ============================================================================
// API KEYS
// ============================================================================

/// API keys for machine-to-machine authentication
model ApiKey {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Key identification
  name        String   @db.VarChar(255)
  description String?  @db.Text
  prefix      String   @db.VarChar(10) // First 8 chars for identification (e.g., "hrp_live")
  keyHash     String   @map("key_hash") @db.Text // SHA-256 hash of the full key

  // Permissions scoping
  permissions String[] @default([]) // Subset of Permission enum values

  // Rate limiting
  rateLimit   Int      @default(1000) @map("rate_limit") // requests per hour

  // Validity
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz

  // Created by
  createdBy   String   @map("created_by") @db.Uuid

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User    @relation("ApiKeyCreator", fields: [createdBy], references: [id])

  @@unique([prefix])
  @@index([companyId])
  @@index([keyHash])
  @@map("api_keys")
}

// ============================================================================
// WEBHOOKS
// ============================================================================

/// Webhook endpoints configured by companies
model WebhookEndpoint {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Endpoint config
  name      String   @db.VarChar(255)
  url       String   @db.Text
  secret    String   @db.Text // HMAC signing secret

  // Event subscriptions (array of event names)
  events    String[] @default([]) // e.g., ["leave.approved", "employee.created"]

  // Headers (custom headers to include)
  headers   Json     @default("{}") @db.JsonB

  // Retry config
  maxRetries Int     @default(3) @map("max_retries")

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([companyId])
  @@index([isActive])
  @@map("webhook_endpoints")
}

/// Webhook delivery attempts and logs
model WebhookDelivery {
  id         String   @id @default(uuid()) @db.Uuid
  endpointId String   @map("endpoint_id") @db.Uuid

  // Event info
  eventType  String   @map("event_type") @db.VarChar(100)
  payload    Json     @db.JsonB

  // Delivery status
  status     String   @default("PENDING") @db.VarChar(50) // PENDING, SUCCESS, FAILED, RETRYING
  statusCode Int?     @map("status_code")
  response   String?  @db.Text

  // Retry tracking
  attempt    Int      @default(1)
  maxRetries Int      @map("max_retries")
  nextRetryAt DateTime? @map("next_retry_at") @db.Timestamptz

  // Timing
  deliveredAt DateTime? @map("delivered_at") @db.Timestamptz
  duration    Int?     // Response time in ms

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  endpoint WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([endpointId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// CUSTOM FIELDS
// ============================================================================

/// Custom field definitions per company
model CustomFieldDefinition {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Field definition
  name        String   @db.VarChar(255) // Display name
  fieldKey    String   @map("field_key") @db.VarChar(100) // Machine-readable key
  description String?  @db.Text

  // Entity type this field belongs to
  entityType  String   @map("entity_type") @db.VarChar(100) // EMPLOYEE, DEPARTMENT, LEAVE, etc.

  // Field type
  fieldType   String   @map("field_type") @db.VarChar(50) // TEXT, NUMBER, DATE, SELECT, MULTI_SELECT, BOOLEAN, URL, EMAIL

  // Options for SELECT/MULTI_SELECT (JSON array of {value, label})
  options     Json?    @db.JsonB

  // Validation
  isRequired  Boolean  @default(false) @map("is_required")
  defaultValue String? @map("default_value") @db.Text

  // Display
  displayOrder Int     @default(0) @map("display_order")

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  values  CustomFieldValue[]

  @@unique([companyId, entityType, fieldKey])
  @@index([companyId])
  @@index([entityType])
  @@map("custom_field_definitions")
}

/// Custom field values stored per entity instance
model CustomFieldValue {
  id           String   @id @default(uuid()) @db.Uuid
  definitionId String   @map("definition_id") @db.Uuid

  // Which entity instance this value belongs to
  entityId     String   @map("entity_id") @db.Uuid

  // The actual value (stored as text, parsed based on field type)
  value        String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  definition CustomFieldDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  @@unique([definitionId, entityId])
  @@index([definitionId])
  @@index([entityId])
  @@map("custom_field_values")
}

// ============================================================================
// PERFORMANCE MANAGEMENT
// ============================================================================

/// Performance review cycle (e.g., Q1 2025 Review, Annual 2025)
model ReviewCycle {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Cycle info
  name        String   @db.VarChar(255)
  description String?  @db.Text
  cycleType   String   @map("cycle_type") @db.VarChar(50) // QUARTERLY, HALF_YEARLY, ANNUAL, CUSTOM

  // Period
  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date

  // Self-assessment & review deadlines
  selfReviewDeadline    DateTime? @map("self_review_deadline") @db.Timestamptz
  managerReviewDeadline DateTime? @map("manager_review_deadline") @db.Timestamptz

  // Rating scale config (JSON: { min, max, labels: { 1: 'Needs Improvement', ... } })
  ratingScale Json? @map("rating_scale") @db.JsonB

  // Status
  status    String   @default("DRAFT") @db.VarChar(50) // DRAFT, ACTIVE, COMPLETED, CANCELLED
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviews PerformanceReview[]

  @@index([companyId])
  @@index([status])
  @@map("review_cycles")
}

/// Individual performance review for an employee in a cycle
model PerformanceReview {
  id           String   @id @default(uuid()) @db.Uuid
  companyId    String   @map("company_id") @db.Uuid
  cycleId      String   @map("cycle_id") @db.Uuid
  employeeId   String   @map("employee_id") @db.Uuid
  reviewerId   String?  @map("reviewer_id") @db.Uuid

  // Self assessment
  selfRating   Decimal? @map("self_rating") @db.Decimal(3, 1)
  selfComments String?  @map("self_comments") @db.Text

  // Manager review
  managerRating   Decimal? @map("manager_rating") @db.Decimal(3, 1)
  managerComments String?  @map("manager_comments") @db.Text

  // Overall
  finalRating  Decimal? @map("final_rating") @db.Decimal(3, 1)
  overallComments String? @map("overall_comments") @db.Text

  // Status
  status    String   @default("PENDING") @db.VarChar(50) // PENDING, SELF_REVIEW, MANAGER_REVIEW, COMPLETED
  completedAt DateTime? @map("completed_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  cycle    ReviewCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  goals    Goal[]

  @@unique([cycleId, employeeId])
  @@index([companyId])
  @@index([cycleId])
  @@index([employeeId])
  @@index([status])
  @@map("performance_reviews")
}

/// Goals / OKRs for employees
model Goal {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid

  // Goal info
  title       String   @db.VarChar(255)
  description String?  @db.Text
  category    String?  @db.VarChar(100) // INDIVIDUAL, TEAM, COMPANY
  priority    String   @default("MEDIUM") @db.VarChar(50) // LOW, MEDIUM, HIGH, CRITICAL

  // Timeline
  startDate   DateTime? @map("start_date") @db.Date
  dueDate     DateTime? @map("due_date") @db.Date

  // Progress
  progress    Int      @default(0) // 0-100
  weightage   Decimal  @default(1) @db.Decimal(3, 2) // Weight for scoring (0.0-1.0)

  // Key Results (JSON array: [{ title, targetValue, currentValue, unit }])
  keyResults  Json?    @map("key_results") @db.JsonB

  // Link to review (optional)
  reviewId    String?  @map("review_id") @db.Uuid

  // Status
  status    String   @default("NOT_STARTED") @db.VarChar(50) // NOT_STARTED, IN_PROGRESS, COMPLETED, CANCELLED
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  review PerformanceReview? @relation(fields: [reviewId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@map("goals")
}

// ============================================================================
// RECRUITMENT / ATS
// ============================================================================

/// Job postings / openings
model JobPosting {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid

  // Job info
  title       String   @db.VarChar(255)
  description String   @db.Text
  requirements String?  @db.Text

  // Location & type
  location    String?  @db.VarChar(255)
  jobType     String   @default("FULL_TIME") @map("job_type") @db.VarChar(50) // FULL_TIME, PART_TIME, CONTRACT, INTERN, REMOTE
  experience  String?  @db.VarChar(100) // e.g., "2-5 years"

  // Salary range
  salaryMin    Decimal? @map("salary_min") @db.Decimal(15, 2)
  salaryMax    Decimal? @map("salary_max") @db.Decimal(15, 2)
  currency     String   @default("INR") @db.VarChar(10)
  showSalary   Boolean  @default(false) @map("show_salary")

  // Organization
  departmentId   String? @map("department_id") @db.Uuid
  designationId  String? @map("designation_id") @db.Uuid
  hiringManagerId String? @map("hiring_manager_id") @db.Uuid

  // Openings
  openings    Int      @default(1)
  filled      Int      @default(0)

  // Dates
  publishedAt DateTime? @map("published_at") @db.Timestamptz
  closingDate DateTime? @map("closing_date") @db.Date

  // Status
  status    String   @default("DRAFT") @db.VarChar(50) // DRAFT, PUBLISHED, PAUSED, CLOSED, FILLED
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applicants Applicant[]

  @@index([companyId])
  @@index([status])
  @@index([departmentId])
  @@map("job_postings")
}

/// Applicants / Candidates
model Applicant {
  id           String   @id @default(uuid()) @db.Uuid
  companyId    String   @map("company_id") @db.Uuid
  jobPostingId String   @map("job_posting_id") @db.Uuid

  // Candidate info
  firstName    String   @map("first_name") @db.VarChar(100)
  lastName     String   @map("last_name") @db.VarChar(100)
  email        String   @db.VarChar(255)
  phone        String?  @db.VarChar(20)

  // Resume / CV
  resumePath   String?  @map("resume_path") @db.Text
  coverLetter  String?  @map("cover_letter") @db.Text

  // Source
  source       String?  @db.VarChar(100) // WEBSITE, REFERRAL, LINKEDIN, JOB_BOARD, OTHER

  // Pipeline stage
  stage        String   @default("APPLIED") @db.VarChar(50) // APPLIED, SCREENING, INTERVIEW, ASSESSMENT, OFFER, HIRED, REJECTED
  stageNotes   String?  @map("stage_notes") @db.Text

  // Rating
  rating       Int?     // 1-5 stars

  // Offer details
  offerSalary  Decimal? @map("offer_salary") @db.Decimal(15, 2)
  offerDate    DateTime? @map("offer_date") @db.Date
  joinDate     DateTime? @map("join_date") @db.Date

  // Status
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPosting JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([companyId])
  @@index([jobPostingId])
  @@index([stage])
  @@index([email])
  @@map("applicants")
}

/// Interviews scheduled for applicants
model Interview {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  applicantId String   @map("applicant_id") @db.Uuid

  // Schedule
  scheduledAt DateTime @map("scheduled_at") @db.Timestamptz
  duration    Int      @default(60) // minutes
  location    String?  @db.VarChar(255) // Room name, video link, etc.

  // Type
  interviewType String @default("IN_PERSON") @map("interview_type") @db.VarChar(50) // IN_PERSON, PHONE, VIDEO
  round         Int    @default(1)

  // Interviewer
  interviewerId String? @map("interviewer_id") @db.Uuid

  // Feedback
  feedback    String?  @db.Text
  rating      Int?     // 1-5
  recommendation String? @db.VarChar(50) // STRONG_HIRE, HIRE, NO_HIRE, STRONG_NO_HIRE

  // Status
  status    String   @default("SCHEDULED") @db.VarChar(50) // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  applicant Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([applicantId])
  @@index([scheduledAt])
  @@map("interviews")
}

// ============================================================================
// TRAINING / LMS
// ============================================================================

/// Training courses
model TrainingCourse {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Course info
  title       String   @db.VarChar(255)
  description String?  @db.Text
  category    String?  @db.VarChar(100) // TECHNICAL, COMPLIANCE, SOFT_SKILLS, ONBOARDING, LEADERSHIP
  instructor  String?  @db.VarChar(255)

  // Content
  contentUrl  String?  @map("content_url") @db.Text // External LMS link or document URL
  duration    Int?     // Duration in hours

  // Schedule
  startDate   DateTime? @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date

  // Capacity
  maxEnrollments Int? @map("max_enrollments")
  isMandatory    Boolean @default(false) @map("is_mandatory")

  // Status
  status    String   @default("DRAFT") @db.VarChar(50) // DRAFT, PUBLISHED, IN_PROGRESS, COMPLETED, CANCELLED
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enrollments TrainingEnrollment[]

  @@index([companyId])
  @@index([status])
  @@index([category])
  @@map("training_courses")
}

/// Training enrollments (employee-course relationship)
model TrainingEnrollment {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  courseId   String   @map("course_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid

  // Progress
  progress      Int       @default(0) // 0-100
  completedAt   DateTime? @map("completed_at") @db.Timestamptz

  // Assessment
  score         Decimal?  @db.Decimal(5, 2)
  passed        Boolean?

  // Certificate
  certificateUrl String?  @map("certificate_url") @db.Text

  // Status
  status    String   @default("ENROLLED") @db.VarChar(50) // ENROLLED, IN_PROGRESS, COMPLETED, DROPPED, FAILED
  enrolledAt DateTime @default(now()) @map("enrolled_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  course TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, employeeId])
  @@index([companyId])
  @@index([courseId])
  @@index([employeeId])
  @@index([status])
  @@map("training_enrollments")
}

// ============================================================================
// ASSET MANAGEMENT
// ============================================================================

/// Company assets (laptops, phones, desks, etc.)
model Asset {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Asset info
  name         String   @db.VarChar(255)
  assetCode    String   @map("asset_code") @db.VarChar(100) // Unique identifier/serial
  description  String?  @db.Text
  category     String   @db.VarChar(100) // LAPTOP, PHONE, MONITOR, DESK, CHAIR, VEHICLE, SOFTWARE_LICENSE, OTHER
  brand        String?  @db.VarChar(100)
  model        String?  @db.VarChar(100)
  serialNumber String?  @map("serial_number") @db.VarChar(255)

  // Purchase info
  purchaseDate  DateTime? @map("purchase_date") @db.Date
  purchasePrice Decimal?  @map("purchase_price") @db.Decimal(15, 2)
  warrantyExpiry DateTime? @map("warranty_expiry") @db.Date

  // Current assignment
  assignedTo   String?   @map("assigned_to") @db.Uuid // Employee ID
  assignedAt   DateTime? @map("assigned_at") @db.Timestamptz

  // Condition & location
  condition    String   @default("GOOD") @db.VarChar(50) // NEW, GOOD, FAIR, POOR, DAMAGED, DISPOSED
  location     String?  @db.VarChar(255)

  // Status
  status    String   @default("AVAILABLE") @db.VarChar(50) // AVAILABLE, ASSIGNED, UNDER_MAINTENANCE, RETIRED, DISPOSED
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignments AssetAssignment[]

  @@unique([companyId, assetCode])
  @@index([companyId])
  @@index([status])
  @@index([assignedTo])
  @@index([category])
  @@map("assets")
}

/// Asset assignment history
model AssetAssignment {
  id        String   @id @default(uuid()) @db.Uuid
  assetId   String   @map("asset_id") @db.Uuid
  employeeId String  @map("employee_id") @db.Uuid

  // Assignment period
  assignedAt    DateTime  @map("assigned_at") @db.Timestamptz
  returnedAt    DateTime? @map("returned_at") @db.Timestamptz

  // Notes
  assignmentNotes String? @map("assignment_notes") @db.Text
  returnNotes     String? @map("return_notes") @db.Text
  conditionOnReturn String? @map("condition_on_return") @db.VarChar(50)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([employeeId])
  @@map("asset_assignments")
}

// ============================================================================
// EXPENSE MANAGEMENT
// ============================================================================

/// Expense claims by employees
model ExpenseClaim {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid

  // Claim info
  title       String   @db.VarChar(255)
  description String?  @db.Text
  category    String   @db.VarChar(100) // TRAVEL, FOOD, ACCOMMODATION, EQUIPMENT, COMMUNICATION, TRAINING, OTHER

  // Amount
  amount      Decimal  @db.Decimal(15, 2)
  currency    String   @default("INR") @db.VarChar(10)

  // Receipt
  receiptPath String?  @map("receipt_path") @db.Text
  expenseDate DateTime @map("expense_date") @db.Date

  // Approval
  status      String   @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED, REIMBURSED, CANCELLED
  approvedBy  String?  @map("approved_by") @db.Uuid
  approvedAt  DateTime? @map("approved_at") @db.Timestamptz
  approvalNotes String? @map("approval_notes") @db.Text

  // Reimbursement
  reimbursedAt   DateTime? @map("reimbursed_at") @db.Timestamptz
  reimbursedAmount Decimal? @map("reimbursed_amount") @db.Decimal(15, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([expenseDate])
  @@map("expense_claims")
}

// ============================================================================
// SHIFT MANAGEMENT
// ============================================================================

/// Shift definitions (e.g., Morning 9-5, Night 10pm-6am)
model ShiftDefinition {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Shift info
  name        String   @db.VarChar(255)
  code        String   @db.VarChar(50)
  description String?  @db.Text
  color       String?  @db.VarChar(7) // Hex color for UI

  // Timing
  startTime   String   @map("start_time") @db.VarChar(5) // HH:mm format
  endTime     String   @map("end_time") @db.VarChar(5) // HH:mm format
  breakDuration Int    @default(60) @map("break_duration") // minutes
  isOvernight Boolean  @default(false) @map("is_overnight") // Crosses midnight

  // Grace period (minutes)
  graceMinutes Int    @default(15) @map("grace_minutes")

  // Status
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignments ShiftAssignment[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("shift_definitions")
}

/// Shift assignments (employee-shift-date)
model ShiftAssignment {
  id             String   @id @default(uuid()) @db.Uuid
  companyId      String   @map("company_id") @db.Uuid
  shiftId        String   @map("shift_id") @db.Uuid
  employeeId     String   @map("employee_id") @db.Uuid

  // Assignment date or range
  assignmentDate DateTime @map("assignment_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date // For recurring assignments

  // Notes
  notes          String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  shift ShiftDefinition @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([shiftId, employeeId, assignmentDate])
  @@index([companyId])
  @@index([employeeId])
  @@index([assignmentDate])
  @@map("shift_assignments")
}

// ============================================================================
// POLICY MANAGEMENT
// ============================================================================

/// Company policies and handbooks
model Policy {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Policy info
  title       String   @db.VarChar(255)
  description String?  @db.Text
  content     String   @db.Text // Rich text content (markdown)
  category    String   @db.VarChar(100) // HR, IT, FINANCE, COMPLIANCE, SAFETY, GENERAL
  version     String   @default("1.0") @db.VarChar(20)

  // File attachment (optional PDF version)
  filePath    String?  @map("file_path") @db.Text

  // Publishing
  publishedAt DateTime? @map("published_at") @db.Timestamptz
  effectiveDate DateTime? @map("effective_date") @db.Date

  // Acknowledgment required
  requiresAcknowledgment Boolean @default(false) @map("requires_acknowledgment")

  // Status
  status    String   @default("DRAFT") @db.VarChar(50) // DRAFT, PUBLISHED, ARCHIVED
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company          Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  acknowledgments  PolicyAcknowledgment[]

  @@index([companyId])
  @@index([status])
  @@index([category])
  @@map("policies")
}

/// Employee acknowledgment of policies
model PolicyAcknowledgment {
  id         String   @id @default(uuid()) @db.Uuid
  policyId   String   @map("policy_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid

  // Acknowledgment
  acknowledgedAt DateTime @map("acknowledged_at") @db.Timestamptz
  ipAddress      String?  @map("ip_address") @db.VarChar(45)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, employeeId])
  @@index([policyId])
  @@index([employeeId])
  @@map("policy_acknowledgments")
}

// ═══════════════════════════════════════════════════════════════════
// Feature Add-ons & Billing
// ═══════════════════════════════════════════════════════════════════

/// Feature Add-ons - Purchasable features beyond base tier
model FeatureAddon {
  id          String   @id @default(uuid()) @db.Uuid
  feature     String   @unique @db.VarChar(100) // Feature enum value
  name        String   @db.VarChar(255) // Display name
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2) // Monthly price
  yearlyPrice Decimal? @map("yearly_price") @db.Decimal(10, 2) // Annual price (discount)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  companyAddons CompanyAddon[]

  @@index([feature])
  @@index([isActive])
  @@map("feature_addons")
}

/// Company Add-on assignments
model CompanyAddon {
  id             String    @id @default(uuid()) @db.Uuid
  companyId      String    @map("company_id") @db.Uuid
  featureAddonId String    @map("feature_addon_id") @db.Uuid
  status         String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, CANCELLED, EXPIRED
  activatedAt    DateTime  @default(now()) @map("activated_at") @db.Timestamptz
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  featureAddon FeatureAddon @relation(fields: [featureAddonId], references: [id], onDelete: Cascade)

  @@unique([companyId, featureAddonId])
  @@index([companyId])
  @@index([featureAddonId])
  @@index([status])
  @@map("company_addons")
}

/// Billing Plans - Pricing configuration per tier
model BillingPlan {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @db.VarChar(255) // e.g., "Standard", "Premium"
  tier              String   @db.VarChar(50) // Maps to SubscriptionTier
  basePrice         Decimal  @map("base_price") @db.Decimal(10, 2) // Monthly base price
  yearlyBasePrice   Decimal? @map("yearly_base_price") @db.Decimal(10, 2)
  pricePerEmployee  Decimal  @map("price_per_employee") @db.Decimal(10, 2) // Per-employee monthly cost
  pricePerUser      Decimal  @map("price_per_user") @db.Decimal(10, 2) // Per-user monthly cost
  includedEmployees Int      @default(0) @map("included_employees") // Included in base price
  includedUsers     Int      @default(0) @map("included_users")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  companyBillings CompanyBilling[]

  @@index([tier])
  @@index([isActive])
  @@map("billing_plans")
}

/// Company Billing - Per-company billing configuration
model CompanyBilling {
  id               String    @id @default(uuid()) @db.Uuid
  companyId        String    @unique @map("company_id") @db.Uuid
  billingPlanId    String    @map("billing_plan_id") @db.Uuid
  billingCycle     String    @default("MONTHLY") @map("billing_cycle") @db.VarChar(50) // MONTHLY, YEARLY
  currentEmployees Int       @default(0) @map("current_employees") // Snapshot count
  currentUsers     Int       @default(0) @map("current_users") // Snapshot count
  monthlyTotal     Decimal   @default(0) @map("monthly_total") @db.Decimal(10, 2) // Calculated total
  nextBillingDate  DateTime? @map("next_billing_date") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  billingPlan BillingPlan      @relation(fields: [billingPlanId], references: [id])
  invoices    BillingInvoice[]

  @@index([companyId])
  @@index([billingPlanId])
  @@map("company_billings")
}

/// Billing Invoices - Generated invoices per billing period
model BillingInvoice {
  id               String    @id @default(uuid()) @db.Uuid
  companyBillingId String    @map("company_billing_id") @db.Uuid
  invoiceNumber    String    @unique @map("invoice_number") @db.VarChar(50)
  periodStart      DateTime  @map("period_start") @db.Timestamptz
  periodEnd        DateTime  @map("period_end") @db.Timestamptz
  baseAmount       Decimal   @map("base_amount") @db.Decimal(10, 2)
  employeeAmount   Decimal   @map("employee_amount") @db.Decimal(10, 2) // Extra employees * rate
  userAmount       Decimal   @map("user_amount") @db.Decimal(10, 2) // Extra users * rate
  addonAmount      Decimal   @map("addon_amount") @db.Decimal(10, 2) // Sum of active add-ons
  totalAmount      Decimal   @map("total_amount") @db.Decimal(10, 2)
  status           String    @default("PENDING") @db.VarChar(50) // PENDING, PAID, OVERDUE, CANCELLED
  employeeCount    Int       @map("employee_count") // Snapshot at invoice time
  userCount        Int       @map("user_count")
  lineItems        Json      @map("line_items") @db.JsonB // Detailed breakdown
  issuedAt         DateTime  @default(now()) @map("issued_at") @db.Timestamptz
  dueDate          DateTime  @map("due_date") @db.Timestamptz
  paidAt           DateTime? @map("paid_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  companyBilling CompanyBilling @relation(fields: [companyBillingId], references: [id], onDelete: Cascade)

  @@index([companyBillingId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("billing_invoices")
}

// ============================================================================
// PHASE 6: COMPETITIVE FEATURE PACK
// ============================================================================

/// Approval Delegation - Allow managers to delegate approvals during OOO
model ApprovalDelegation {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  delegatorId String   @map("delegator_id") @db.Uuid
  delegateId  String   @map("delegate_id") @db.Uuid
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  reason      String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  scope       Json     @default("{}") @db.JsonB // { types: ['LEAVE','EXPENSE',...] }
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  delegator User    @relation("DelegationDelegator", fields: [delegatorId], references: [id])
  delegate  User    @relation("DelegationDelegate", fields: [delegateId], references: [id])

  @@unique([delegatorId, startDate, endDate])
  @@index([companyId])
  @@index([delegateId])
  @@index([isActive])
  @@map("approval_delegations")
}

/// Offboarding Checklist - Template for offboarding tasks
model OffboardingChecklist {
  id        String  @id @default(uuid()) @db.Uuid
  companyId String  @map("company_id") @db.Uuid
  name      String  @db.VarChar(255)
  items     Json    @db.JsonB // [{ title, assignedRole, order }]
  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("offboarding_checklists")
}

/// Offboarding Process - Active offboarding for an employee
model OffboardingProcess {
  id                    String    @id @default(uuid()) @db.Uuid
  companyId             String    @map("company_id") @db.Uuid
  employeeId            String    @map("employee_id") @db.Uuid
  initiatedBy           String    @map("initiated_by") @db.Uuid
  separationType        String    @map("separation_type") @db.VarChar(50) // RESIGNATION, TERMINATION, etc.
  lastWorkingDay        DateTime  @map("last_working_day") @db.Date
  noticePeriodDays      Int?      @map("notice_period_days")
  noticePeriodEndDate   DateTime? @map("notice_period_end_date") @db.Date
  exitInterviewCompleted Boolean  @default(false) @map("exit_interview_completed")
  exitInterviewNotes    Json?     @map("exit_interview_notes") @db.JsonB
  finalSettlementStatus String?   @map("final_settlement_status") @db.VarChar(50)
  status                String    @default("INITIATED") @db.VarChar(50) // INITIATED, IN_PROGRESS, COMPLETED, CANCELLED
  completedAt           DateTime? @map("completed_at") @db.Timestamptz
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])
  tasks    OffboardingTask[]

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@map("offboarding_processes")
}

/// Offboarding Task - Individual task in an offboarding process
model OffboardingTask {
  id             String    @id @default(uuid()) @db.Uuid
  processId      String    @map("process_id") @db.Uuid
  title          String    @db.VarChar(255)
  assignedRole   String?   @map("assigned_role") @db.VarChar(50)
  assignedUserId String?   @map("assigned_user_id") @db.Uuid
  status         String    @default("PENDING") @db.VarChar(50) // PENDING, COMPLETED, SKIPPED, BLOCKED
  completedBy    String?   @map("completed_by") @db.Uuid
  completedAt    DateTime? @map("completed_at") @db.Timestamptz
  notes          String?   @db.Text
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  process OffboardingProcess @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@index([processId])
  @@index([status])
  @@map("offboarding_tasks")
}

/// Leave Policy - Accrual rules per leave type
model LeavePolicy {
  id                    String   @id @default(uuid()) @db.Uuid
  companyId             String   @map("company_id") @db.Uuid
  leaveType             String   @map("leave_type") @db.VarChar(50) // CASUAL, SICK, EARNED, etc.
  name                  String   @db.VarChar(255)
  annualEntitlement     Decimal  @map("annual_entitlement") @db.Decimal(5, 1)
  accrualType           String   @map("accrual_type") @db.VarChar(50) // ANNUAL_GRANT, MONTHLY_ACCRUAL, NO_ACCRUAL
  carryoverLimit        Decimal  @default(0) @map("carryover_limit") @db.Decimal(5, 1)
  carryoverExpiryMonths Int?     @map("carryover_expiry_months")
  maxConsecutiveDays    Int?     @map("max_consecutive_days")
  minServiceDaysRequired Int?    @map("min_service_days_required")
  applicableGender      String?  @map("applicable_gender") @db.VarChar(20) // null = all
  isActive              Boolean  @default(true) @map("is_active")
  fiscalYearStart       Int      @default(1) @map("fiscal_year_start") // Month (1-12)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, leaveType])
  @@index([companyId])
  @@map("leave_policies")
}

/// Leave Balance - Per-employee per-type per-fiscal-year balance
model LeaveBalance {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  employeeId  String   @map("employee_id") @db.Uuid
  leaveType   String   @map("leave_type") @db.VarChar(50)
  fiscalYear  Int      @map("fiscal_year") // e.g., 2025
  entitled    Decimal  @default(0) @db.Decimal(5, 1)
  accrued     Decimal  @default(0) @db.Decimal(5, 1)
  used        Decimal  @default(0) @db.Decimal(5, 1)
  carriedOver Decimal  @default(0) @map("carried_over") @db.Decimal(5, 1)
  adjusted    Decimal  @default(0) @db.Decimal(5, 1)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])
  ledger   LeaveBalanceLedger[]

  @@unique([companyId, employeeId, leaveType, fiscalYear])
  @@index([companyId])
  @@index([employeeId])
  @@map("leave_balances")
}

/// Leave Balance Ledger - Transaction history for balance changes
model LeaveBalanceLedger {
  id              String   @id @default(uuid()) @db.Uuid
  balanceId       String   @map("balance_id") @db.Uuid
  transactionType String   @map("transaction_type") @db.VarChar(50) // ACCRUAL, USAGE, CARRYOVER, ADJUSTMENT, EXPIRY, GRANT
  amount          Decimal  @db.Decimal(5, 1)
  runningBalance  Decimal  @map("running_balance") @db.Decimal(5, 1)
  description     String?  @db.Text
  referenceId     String?  @map("reference_id") @db.Uuid // e.g., Leave ID
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  balance LeaveBalance @relation(fields: [balanceId], references: [id], onDelete: Cascade)

  @@index([balanceId])
  @@map("leave_balance_ledger")
}

/// Announcement - Company-wide announcements
model Announcement {
  id          String    @id @default(uuid()) @db.Uuid
  companyId   String    @map("company_id") @db.Uuid
  authorId    String    @map("author_id") @db.Uuid
  title       String    @db.VarChar(255)
  content     String    @db.Text
  priority    String    @default("NORMAL") @db.VarChar(50) // NORMAL, IMPORTANT, URGENT
  isPinned    Boolean   @default(false) @map("is_pinned")
  publishedAt DateTime? @map("published_at") @db.Timestamptz
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([companyId])
  @@index([isActive])
  @@map("announcements")
}

/// Kudos - Peer recognition
model Kudos {
  id                 String   @id @default(uuid()) @db.Uuid
  companyId          String   @map("company_id") @db.Uuid
  senderId           String   @map("sender_id") @db.Uuid
  recipientEmployeeId String  @map("recipient_employee_id") @db.Uuid
  message            String   @db.Text
  category           String   @db.VarChar(50) // TEAMWORK, INNOVATION, etc.
  isPublic           Boolean  @default(true) @map("is_public")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sender    User     @relation("KudosSender", fields: [senderId], references: [id])
  recipient Employee @relation(fields: [recipientEmployeeId], references: [id])

  @@index([companyId])
  @@index([recipientEmployeeId])
  @@map("kudos")
}

/// Survey - Pulse surveys and engagement surveys
model Survey {
  id                String    @id @default(uuid()) @db.Uuid
  companyId         String    @map("company_id") @db.Uuid
  createdBy         String    @map("created_by") @db.Uuid
  title             String    @db.VarChar(255)
  description       String?   @db.Text
  type              String    @db.VarChar(50) // PULSE, ENGAGEMENT, EXIT, CUSTOM
  status            String    @default("DRAFT") @db.VarChar(50) // DRAFT, ACTIVE, CLOSED, ARCHIVED
  isAnonymous       Boolean   @default(true) @map("is_anonymous")
  questions         Json      @db.JsonB // [{ id, type, text, options?, required }]
  scheduleType      String?   @map("schedule_type") @db.VarChar(50) // ONE_TIME, RECURRING
  recurringInterval String?   @map("recurring_interval") @db.VarChar(50) // WEEKLY, MONTHLY, QUARTERLY
  startDate         DateTime? @map("start_date") @db.Timestamptz
  endDate           DateTime? @map("end_date") @db.Timestamptz
  targetAudience    Json?     @map("target_audience") @db.JsonB // { departments?, roles?, all? }
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator   User             @relation(fields: [createdBy], references: [id])
  responses SurveyResponse[]

  @@index([companyId])
  @@index([status])
  @@map("surveys")
}

/// Survey Response - Individual responses to a survey
model SurveyResponse {
  id           String   @id @default(uuid()) @db.Uuid
  surveyId     String   @map("survey_id") @db.Uuid
  respondentId String   @map("respondent_id") @db.Uuid
  answers      Json     @db.JsonB // [{ questionId, value }]
  submittedAt  DateTime @default(now()) @map("submitted_at") @db.Timestamptz

  // Relations
  survey     Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  respondent User   @relation(fields: [respondentId], references: [id])

  @@unique([surveyId, respondentId])
  @@index([surveyId])
  @@map("survey_responses")
}

/// Timesheet - Weekly timesheet for an employee
model Timesheet {
  id            String    @id @default(uuid()) @db.Uuid
  companyId     String    @map("company_id") @db.Uuid
  employeeId    String    @map("employee_id") @db.Uuid
  weekStartDate DateTime  @map("week_start_date") @db.Date
  status        String    @default("DRAFT") @db.VarChar(50) // DRAFT, SUBMITTED, APPROVED, REJECTED
  submittedAt   DateTime? @map("submitted_at") @db.Timestamptz
  approvedBy    String?   @map("approved_by") @db.Uuid
  approvedAt    DateTime? @map("approved_at") @db.Timestamptz
  totalHours    Decimal   @default(0) @map("total_hours") @db.Decimal(6, 2)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee    @relation(fields: [employeeId], references: [id])
  entries  TimeEntry[]

  @@unique([companyId, employeeId, weekStartDate])
  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@map("timesheets")
}

/// Time Entry - Individual time entry within a timesheet
model TimeEntry {
  id              String   @id @default(uuid()) @db.Uuid
  timesheetId     String   @map("timesheet_id") @db.Uuid
  date            DateTime @db.Date
  hours           Decimal  @db.Decimal(4, 2)
  projectName     String?  @map("project_name") @db.VarChar(255)
  taskDescription String?  @map("task_description") @db.Text
  entryType       String   @default("REGULAR") @map("entry_type") @db.VarChar(50) // REGULAR, OVERTIME, BILLABLE, NON_BILLABLE
  isBillable      Boolean  @default(false) @map("is_billable")
  projectId       String?  @map("project_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id])

  @@index([timesheetId])
  @@index([date])
  @@map("time_entries")
}

/// Project - For time tracking categorization
model Project {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  name        String   @db.VarChar(255)
  code        String   @db.VarChar(50)
  clientName  String?  @map("client_name") @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")
  budgetHours Decimal? @map("budget_hours") @db.Decimal(8, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("projects")
}

/// Contractor - External contractor/freelancer profiles
model Contractor {
  id           String    @id @default(uuid()) @db.Uuid
  companyId    String    @map("company_id") @db.Uuid
  firstName    String    @map("first_name") @db.VarChar(100)
  lastName     String    @map("last_name") @db.VarChar(100)
  email        String    @db.VarChar(255)
  phone        String?   @db.VarChar(20)
  companyName  String?   @map("company_name") @db.VarChar(255)
  contractType String    @map("contract_type") @db.VarChar(50) // FIXED_PRICE, HOURLY, MILESTONE
  hourlyRate   Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  startDate    DateTime  @map("start_date") @db.Date
  endDate      DateTime? @map("end_date") @db.Date
  status       String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, INACTIVE, TERMINATED
  taxId        String?   @map("tax_id") @db.VarChar(100)
  bankDetails  Json?     @map("bank_details") @db.JsonB // Encrypted banking info
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company  Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices ContractorInvoice[]

  @@unique([companyId, email])
  @@index([companyId])
  @@index([status])
  @@map("contractors")
}

/// Contractor Invoice - Invoices submitted by contractors
model ContractorInvoice {
  id            String    @id @default(uuid()) @db.Uuid
  companyId     String    @map("company_id") @db.Uuid
  contractorId  String    @map("contractor_id") @db.Uuid
  invoiceNumber String    @map("invoice_number") @db.VarChar(50)
  amount        Decimal   @db.Decimal(12, 2)
  description   String?   @db.Text
  periodStart   DateTime  @map("period_start") @db.Date
  periodEnd     DateTime  @map("period_end") @db.Date
  status        String    @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, PAID, REJECTED
  submittedAt   DateTime  @default(now()) @map("submitted_at") @db.Timestamptz
  approvedBy    String?   @map("approved_by") @db.Uuid
  paidAt        DateTime? @map("paid_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([contractorId])
  @@index([status])
  @@map("contractor_invoices")
}

/// Geofence Zone - Location-based attendance zones
model GeofenceZone {
  id              String   @id @default(uuid()) @db.Uuid
  companyId       String   @map("company_id") @db.Uuid
  name            String   @db.VarChar(255)
  latitude        Decimal  @db.Decimal(10, 8)
  longitude       Decimal  @db.Decimal(11, 8)
  radiusMeters    Int      @map("radius_meters")
  isActive        Boolean  @default(true) @map("is_active")
  allowedIpRanges Json?    @map("allowed_ip_ranges") @db.JsonB // ["192.168.1.0/24", ...]
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("geofence_zones")
}

/// Dashboard Config - Per-user dashboard layout
model DashboardConfig {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  layout    Json     @db.JsonB // [{ widgetId, order, visible, size }]
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("dashboard_configs")
}
