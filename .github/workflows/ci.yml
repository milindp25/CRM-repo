# =============================================================================
# CI Pipeline — Runs on every PR and push to main
# =============================================================================
# Validates: TypeScript compilation, Prisma generation, API builds, Web builds
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  # ---------------------------------------------------------------------------
  # Build shared packages + generate Prisma client
  # ---------------------------------------------------------------------------
  build-shared:
    name: Build Shared Packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build shared package
        run: cd packages/shared && npx tsc

      - name: Generate Prisma client
        run: npx prisma generate --schema=packages/database/prisma/schema.prisma

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

  # ---------------------------------------------------------------------------
  # Build Tenant API (NestJS)
  # ---------------------------------------------------------------------------
  build-api:
    name: Build Tenant API
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Restore shared build
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

      - name: Build API
        run: cd apps/api && npx nest build

  # ---------------------------------------------------------------------------
  # Build Admin API (NestJS)
  # ---------------------------------------------------------------------------
  build-admin-api:
    name: Build Admin API
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Restore shared build
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

      - name: Build Admin API
        run: cd apps/admin-api && npx nest build

  # ---------------------------------------------------------------------------
  # Build Tenant Portal (Next.js)
  # ---------------------------------------------------------------------------
  build-web:
    name: Build Tenant Portal
    runs-on: ubuntu-latest
    needs: build-shared
    env:
      # Next.js requires these at build time for static optimization
      NEXT_PUBLIC_API_URL: "https://api.example.com/v1"
      NEXT_PUBLIC_APP_URL: "https://app.example.com"
      NEXT_PUBLIC_WS_URL: "https://api.example.com"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Restore shared build
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

      - name: Build Web App
        run: cd apps/web && npx next build

  # ---------------------------------------------------------------------------
  # Build Admin Portal (Next.js)
  # ---------------------------------------------------------------------------
  build-admin:
    name: Build Admin Portal
    runs-on: ubuntu-latest
    needs: build-shared
    env:
      NEXT_PUBLIC_API_URL: "https://api.example.com/v1"
      NEXT_PUBLIC_ADMIN_API_URL: "https://admin-api.example.com/v1"
      NEXT_PUBLIC_APP_URL: "https://admin.example.com"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Restore shared build
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

      - name: Build Admin App
        run: cd apps/admin && npx next build

  # ---------------------------------------------------------------------------
  # Database migration check
  # ---------------------------------------------------------------------------
  migration-check:
    name: Migration Check
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Restore shared build
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/shared/dist
            node_modules/.prisma
            node_modules/@prisma
          key: shared-build-${{ github.sha }}

      - name: Validate Prisma schema
        run: npx prisma validate --schema=packages/database/prisma/schema.prisma

      - name: Check for pending migrations
        run: npx prisma migrate diff --from-migrations --to-schema-datamodel packages/database/prisma/schema.prisma --shadow-database-url "${{ secrets.SHADOW_DATABASE_URL }}" --exit-code || echo "⚠️  Schema drift detected — run 'prisma migrate dev' locally"
        continue-on-error: true
